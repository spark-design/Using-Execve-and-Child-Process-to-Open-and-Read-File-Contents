/* 
Student Name: Connor Sparkman
Student NetID: cps260 
Compiler Used: Linux CMD
Program Description: Program uses execve and a child process to open a file of 60 random ints 0-100 and reads them, prints them out, calculates average, and prints out the average
*/ 
#include <string.h>
#include <stdio.h>
#include <sys/types.h>
#include <time.h>
#include <errno.h>
#include <stdlib.h>
#include <fcntl.h>
#include <stdbool.h>
#include <unistd.h>
#include <signal.h>
#include <sys/time.h>
#include <math.h>
#include <sys/wait.h>

union data 							// global variables to access
{
	int number;
	char bytes[4];
} uni; 							// renaming the union to use in main


int main ()
{
    pid_t cPid; 						// PID of the child
    char myRandFile[1024]; 
    int  xnumber, status, avg, sum; 				// initialize vars
    
    char *newargv[] = { "myRand", NULL };
    char *newenviron[] = { NULL }; 				// for execve. info found here: linux.die.net/man/2/execve
    
    
    
	cPid = fork(); 					// fork to create a child
	switch(cPid)
    	{
    	case -1: 						// fail case
        	perror("fail to fork");
        	exit(EXIT_FAILURE);
    	case 0: 						// success case
    		execve("./myRand",newargv,newenviron);
    		exit(EXIT_SUCCESS);
    	break;
    	default:
        	wait(&status);
        	xnumber = WEXITSTATUS(status);
        	sprintf(myRandFile,"data%d.dat",xnumber); 	// add x value to name of file to open
        	int fd = open(myRandFile,O_RDONLY);  		// open and read the file while not EOF
        	if(fd == -1) 
        	{
        	perror("fail to open");
        	}
        	while(read(fd,uni.bytes,2) > 0) 		// reading until EOF
        	{       
        		printf("%d\n",uni.number); 		// print each value
        		sum += uni.number;         		// add to sum
        	}
        	close(fd); 					// close the file
        
        	avg = sum/60; 					// divide value sum by 60 for average
        	printf("Average:%d",avg);			// print the average
        }
        exit(EXIT_SUCCESS);					// exit the program successfully
}	
